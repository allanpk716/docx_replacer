# 批注功能说明

## 功能概述

DocuFiller 支持在 Word 文档中自动添加批注,用于记录内容控件的修改历史和变更信息。

## 重要限制

### 页眉页脚不支持批注

**OpenXML 和 Microsoft Word 的设计限制:**

- 页眉和页脚**不支持**批注功能
- 这是 Microsoft Word 的原生限制,不是代码实现问题
- 即使通过 OpenXML API 尝试添加批注到页眉页脚,也会静默失败
- Word UI 中在页眉页脚编辑时,批注功能是**禁用状态**

**技术原因:**

根据 OOXML 规范 (ISO/IEC 29500):
- Comments 部分只能与 **Main Document Part** 建立关系
- 文档包中最多只能有**两个** Comments 部分:
  - 一个关联到主文档 (Main Document)
  - 一个关联到文档部件 (Glossary Document)
- **Header 和 Footer 部分无法建立与 Comments 部分的关系**

**参考信息:**

- [OfficeDev/office-js Issue #341](https://github.com/OfficeDev/office-js/issues/341): 官方确认页眉页脚不能有批注
- [OOXML 规范 11.3.2 Comments Part](https://ooxml.info/docs/11/11.3/11.3.2): 定义了 Comments 部分的关系约束

## 支持的功能

### 正文区域批注

DocuFiller **仅支持在正文区域**添加批注,功能包括:

1. **单行批注**: 为单个 Run 元素添加批注
2. **多行批注**: 为多个连续的 Run 元素添加范围批注
3. **全局唯一 ID**: 所有批注使用全局唯一 ID,避免冲突
4. **变更追踪**: 记录旧值、新值、修改时间和位置信息

### 批注内容格式

```
此字段(正文)已于 2026年1月8日 16:10:00 更新。
标签: FieldName, 旧值: [OriginalValue], 新值: NewValue
```

## 使用建议

### 如果需要在页眉页脚中添加提示信息

由于批注功能不可用,可以考虑以下替代方案:

1. **使用文本框**: 在页眉页脚中插入文本框或格式化文本来显示提示信息
2. **使用书签**: 在页眉页脚中插入书签,然后在正文最近位置添加批注引用
3. **简化文档**: 将必要的提示信息放在正文区域,而不是页眉页脚

### 文档模板设计

在设计模板时:
- 将需要批注的内容控件放在**正文区域**
- 页眉页脚仅放置不需要追踪变更的静态内容
- 如果必须追踪页眉页脚的变更,考虑使用其他方式记录

## 实现细节

### 代码架构

- `CommentManager`: 负责批注的创建和管理
- `ContentControlProcessor`: 在内容控件替换后自动添加批注
- 批注存储位置: `WordprocessingCommentsPart` (主文档)
- 批注引用: 通过 `CommentRangeStart`, `CommentRangeEnd`, `CommentReference` 元素

### 跳过页眉页脚批注

在 `ContentControlProcessor.cs` 中:

```csharp
// 添加批注(仅正文区域支持,页眉页脚不支持批注)
if (location == ContentControlLocation.Body)
{
    AddProcessingComment(document, control, tag, value, oldValue, location);
}
else
{
    _logger.LogDebug($"跳过批注添加(页眉页脚不支持批注功能),标签: '{tag}', 位置: {location}");
}
```

## 总结

DocuFiller 的批注功能专注于正文区域,这是由于 OpenXML 和 Microsoft Word 的技术限制决定的。虽然页眉页脚不支持批注,但正文区域的批注功能完整可用,能够有效追踪文档内容的变更历史。
